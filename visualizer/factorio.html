<html>
<head>
<script src="vivagraph.js"></script>
<script src="recipes.json"></script>
<script>

    var renderer = null;

    const products = {};

    const guns = ['pistol', 'submachine-gun', 'shotgun', 'combat-shotgun', 'railgun', 'rocket-launcher', 'flamethrower'];
    const vehicles = ['car', 'tank', 'locomotive', 'fluid-wagon', 'cargo-wagon'];
    const limited = ['rocket-silo', 'resource-monitor', 'small-plane', 'oil-refinery', 'lab']

    function handleProductSelection(selector) {
        const productName = selector.target['data-product'];
        products[productName].isExcluded = !selector.target.checked;
        createGraph();
    }

    function initializeProduct(productName) {
        if(!(productName in products)) {
            const product = { isExcluded: false, isIngredient: false };
            if(productName.endsWith('equipment')
                || productName.includes('armor')
                || guns.includes(productName)
                || vehicles.includes(productName)
                || productName.endsWith('barrel')
                || limited.includes(productName)) {
                product.isExcluded = true;
            }
            products[productName] = product;
        }
    }

    function createGraph() {
        if(null != renderer) {
            renderer.dispose();
            renderer = null;
        }

        var graph = Viva.Graph.graph();

        recipes.forEach(function(item) {
            for(productName in item.produces) {
                initializeProduct(productName);
                if(products[productName].isExcluded) {
                    continue;
                }
                graph.addNode(productName, productName);
                for(ingredientName in item.ingredients) {
                    initializeProduct(ingredientName);
                    products[ingredientName].isIngredient = true;
                    if(products[ingredientName].isExcluded) {
                        continue;
                    }
                    graph.addNode(ingredientName, ingredientName);
                    graph.addLink(ingredientName, productName, item.ingredients[ingredientName]);
                };
            };
        });

        var graphics = Viva.Graph.View.svgGraphics();

        graphics
            .node(function(node) {
                return Viva.Graph.svg('text')
                    .text(node.data);
            });

        graphics.link(function(link){
            // Notice the Triangle marker-end attribe:
            return Viva.Graph.svg('path')
                        .attr('stroke', 'gray')
                        .attr('marker-end', 'url(#Triangle)');
        }).placeLink(function(linkUI, fromPos, toPos) {
            var data = 'M' + fromPos.x + ',' + fromPos.y +
                        'L' + toPos.x + ',' + toPos.y;
            linkUI.attr("d", data);
        });

        // Rendering arrow shape is achieved by using SVG markers, part of the SVG
        // standard: http://www.w3.org/TR/SVG/painting.html#Markers
        var createMarker = function(id) {
                return Viva.Graph.svg('marker')
                            .attr('id', id)
                            .attr('viewBox', "0 0 10 10")
                            .attr('refX', "10")
                            .attr('refY', "5")
                            .attr('markerUnits', "strokeWidth")
                            .attr('markerWidth', "10")
                            .attr('markerHeight', "5")
                            .attr('orient', "auto");
            },
            marker = createMarker('Triangle');
        marker.append('path').attr('d', 'M 0 0 L 10 5 L 0 10 z');
        // Marker should be defined only once in <defs> child element of root <svg> element:
        var defs = graphics.getSvgRoot().append('defs');
        defs.append(marker);

        var layout = Viva.Graph.Layout.forceDirected(graph, {
            springLength : 200,
            springCoeff : 0.00005,
            dragCoeff : 0.01,
            gravity : -2.2
        });

        renderer = Viva.Graph.View.renderer(graph,
        {
            container: document.getElementById('graphDiv'),
            graphics: graphics,
            layout: layout
        }
        );
        renderer.run();

        const selections = document.getElementById('selections');
        selections.innerHTML = '';
        for(productName in products) {
            const product = products[productName];
            if(!product.isIngredient) {
                const productDiv = document.createElement('div');
                const productSelector = document.createElement('input');
                productSelector.type = 'checkbox';
                productSelector['data-product'] = productName;
                productSelector.onclick = handleProductSelection;
                productSelector.defaultChecked = !product.isExcluded;
                productDiv.appendChild(productSelector);
                const productLabel = document.createElement('label');
                productLabel.innerText = productName;
                productDiv.appendChild(productLabel);
                selections.appendChild(productDiv);
            }
        };
    }

    function handlePauseResumeClick(button) {
        if(button.value === 'Pause') {
            renderer.pause();
            button.value = 'Resume';
        } else {
            renderer.resume();
            button.value = 'Pause';
        }
    }
    </script>
</head>
<body onload="createGraph()">
    <div style="display: flex; flex-direction: row; width: 100%; height: 100vh; overflow: hidden;">
        <div style="flex: 1; overflow: auto; height: auto;" id="selections"></div>
        <div style="flex: 6; display: flex; flex-direction: column">
            <div style="flex: 1;">
                <input type="button" onclick="handlePauseResumeClick(this)" value="Pause"/>
            </div>
            <svg style="flex: 8; overflow: auto; height: auto" id="graphDiv"></svg>
        </div>
    </div>
</body>
</html>