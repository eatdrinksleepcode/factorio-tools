<html>
<head>
<script src="vivagraph.js"></script>
<script src="utils.js"></script>
<script src="recipes.json"></script>
<script src="items.js"></script>
<script>

    var renderer = null;

    const products = new ItemList(recipes).items;

    function handleProductSelection(selector) {
        const productName = selector.target['data-product'];
        products[productName].isIncluded = selector.target.checked;
        createGraph();
    }

    function makeExpansiveProductsTransparent(ingredientName) {
        if(ingredientName === 'iron-gear-wheel' || ingredientName == 'pipe') {
            ingredientName = 'iron-plate';
        } else if(ingredientName === 'copper-cable') {
            ingredientName = 'copper-plate';
        }
        return ingredientName;
    }

    function createGraph() {
        if(null != renderer) {
            renderer.dispose();
            renderer = null;
        }

        var graph = Viva.Graph.graph();

        for(productName in products) {
            const product = products[productName];
            if(!product.isIncluded) {
                continue;
            }
            graph.addNode(productName, product);
            for(ingredientName in product.ingredients) {
                // ingredientName = makeExpansiveProductsTransparent(ingredientName);
                if(!products[ingredientName].isIncluded) {
                    continue;
                }
                graph.addNode(ingredientName, products[ingredientName]);
                graph.addLink(ingredientName, productName, product.ingredients[ingredientName]);
            };
        };

        var graphics = Viva.Graph.View.svgGraphics();

        graphics
            .node(function(node) {
                return Viva.Graph.svg('text')
                    .text(node.data.displayName);
            });

        graphics.link(function(link){
            // Notice the Triangle marker-end attribe:
            return Viva.Graph.svg('path')
                        .attr('stroke', 'gray')
                        .attr('marker-end', 'url(#Triangle)');
        }).placeLink(function(linkUI, fromPos, toPos) {
            var data = 'M' + fromPos.x + ',' + fromPos.y +
                        'L' + toPos.x + ',' + toPos.y;
            linkUI.attr("d", data);
        });

        // Rendering arrow shape is achieved by using SVG markers, part of the SVG
        // standard: http://www.w3.org/TR/SVG/painting.html#Markers
        var createMarker = function(id) {
                return Viva.Graph.svg('marker')
                            .attr('id', id)
                            .attr('viewBox', "0 0 10 10")
                            .attr('refX', "10")
                            .attr('refY', "5")
                            .attr('markerUnits', "strokeWidth")
                            .attr('markerWidth', "10")
                            .attr('markerHeight', "5")
                            .attr('orient', "auto");
            },
            marker = createMarker('Triangle');
        marker.append('path').attr('d', 'M 0 0 L 10 5 L 0 10 z');
        // Marker should be defined only once in <defs> child element of root <svg> element:
        var defs = graphics.getSvgRoot().append('defs');
        defs.append(marker);

        var layout = Viva.Graph.Layout.forceDirected(graph, {
            springLength : 200,
            springCoeff : 0.00005,
            dragCoeff : 0.002,
            gravity : -3.2
        });

        renderer = Viva.Graph.View.renderer(graph,
        {
            container: document.getElementById('graphDiv'),
            graphics: graphics,
            layout: layout
        }
        );
        renderer.run();

        const selections = document.getElementById('selections');
        selections.innerHTML = '';
        Object.keys(products).sort().forEach(function(productName) {
            const product = products[productName];
            if(!product.isExcluded && Object.keys(product.ingredients).every(ingredientName => products[ingredientName].isIncluded)) {
                const productDiv = document.createElement('div');
                const productSelector = document.createElement('input');
                productSelector.type = 'checkbox';
                productSelector['data-product'] = productName;
                productSelector.onclick = handleProductSelection;
                productSelector.defaultChecked = product.isIncluded;
                productDiv.appendChild(productSelector);
                const productLabel = document.createElement('label');
                productLabel.innerText = productName;
                productDiv.appendChild(productLabel);
                selections.appendChild(productDiv);
            }
        });
    }

    function handlePauseResumeClick(button) {
        if(button.value === 'Pause') {
            renderer.pause();
            button.value = 'Resume';
        } else {
            renderer.resume();
            button.value = 'Pause';
        }
    }
    </script>
</head>
<body onload="createGraph()">
    <div style="display: flex; flex-direction: row; width: 100%; height: 100vh; overflow: hidden;">
        <div style="flex: 1; overflow: auto; height: auto;" id="selections"></div>
        <div style="flex: 6; display: flex; flex-direction: column">
            <div style="flex: 1;">
                <input type="button" onclick="handlePauseResumeClick(this)" value="Pause"/>
            </div>
            <svg style="flex: 8; overflow: auto; height: auto" id="graphDiv"></svg>
        </div>
    </div>
</body>
</html>